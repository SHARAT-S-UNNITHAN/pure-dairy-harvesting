{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>Admin Dashboard</h2>
    
    <div class="row">
        <div class="col-md-3">
            <div class="card text-white bg-primary mb-3">
                <div class="card-body">
                    <h5 class="card-title">{{ users|length }}</h5>
                    <p class="card-text">Total Users</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success mb-3">
                <div class="card-body">
                    <h5 class="card-title">{{ products|length }}</h5>
                    <p class="card-text">Total Products</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-info mb-3">
                <div class="card-body">
                    <h5 class="card-title">{{ orders|length }}</h5>
                    <p class="card-text">Total Orders</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning mb-3">
                <div class="card-body">
                    <h5 class="card-title">{{ categories|length }}</h5>
                    <p class="card-text">Categories</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Farmers Pending Approval Section -->
    <div class="card mt-4">
        <div class="card-header bg-warning">
            <h4>Farmers Pending Approval</h4>
        </div>
        <div class="card-body">
            {% set pending_farmers = users|selectattr('role.name', 'equalto', 'farmer')|selectattr('is_approved', 'false')|list %}
            {% if pending_farmers %}
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Farm Name</th>
                            <th>Location</th>
                            <th>License Document</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for farmer in pending_farmers %}
                        <tr>
                            <td>{{ farmer.id }}</td>
                            <td>{{ farmer.name }}</td>
                            <td>{{ farmer.email }}</td>
                            <td>{{ farmer.farm_name }}</td>
                            <td>{{ farmer.location }}</td>
                            <td>
                                {% if farmer.license_filename %}
                                <a href="{{ url_for('serve_license', filename=farmer.license_filename) }}" target="_blank" class="btn btn-info btn-sm">View License</a>
                                {% else %}
                                <span class="text-muted">No License</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{{ url_for('approve_farmer', user_id=farmer.id) }}" class="btn btn-success btn-sm">Approve Farmer</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
                <p class="text-muted">No farmers waiting for approval.</p>
            {% endif %}
        </div>
    </div>

    <!-- Products Pending Approval Section -->
    <div class="card mt-4">
        <div class="card-header bg-info text-white">
            <h4>Products Pending Approval</h4>
        </div>
        <div class="card-body">
            {% set pending_products = products|selectattr('approved', 'false')|list %}
            {% if pending_products %}
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Image</th>
                            <th>Name</th>
                            <th>Farmer</th>
                            <th>Price</th>
                            <th>Quantity</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product in pending_products %}
                        <tr>
                            <td>{{ product.id }}</td>
                            <td>
                                {% if product.image %}
                                <img src="{{ url_for('serve_product_image', filename=product.image) }}" alt="{{ product.name }}" style="width: 50px; height: 50px; object-fit: cover;">
                                {% else %}
                                No Image
                                {% endif %}
                            </td>
                            <td>{{ product.name }}</td>
                            <td>{{ product.farmer.name }}</td>
                            <td>₹{{ product.price }}</td>
                            <td>{{ product.quantity }}</td>
                            <td>
                                <a href="{{ url_for('approve_product', id=product.id) }}" class="btn btn-success btn-sm">Approve</a>
                                <a href="{{ url_for('reject_product', id=product.id) }}" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to reject this product?');">Reject</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
                <p class="text-muted">No products waiting for approval.</p>
            {% endif %}
        </div>
    </div>

    <!-- Approved Products Section -->
    <div class="card mt-4">
        <div class="card-header bg-success text-white">
            <h4>Approved Products</h4>
        </div>
        <div class="card-body">
            {% set approved_products = products|selectattr('approved', 'true')|list %}
            {% if approved_products %}
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Farmer</th>
                            <th>Price</th>
                            <th>Stock</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product in approved_products %}
                        <tr>
                            <td>{{ product.id }}</td>
                            <td>{{ product.name }}</td>
                            <td>{{ product.farmer.name }}</td>
                            <td>₹{{ product.price }}</td>
                            <td>{{ product.quantity }}</td>
                            <td><span class="badge bg-success">Approved</span></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
                <p class="text-muted">No approved products yet.</p>
            {% endif %}
        </div>
    </div>

    <!-- Users Table -->
    <div class="card mt-4">
        <div class="card-header">
            <h4>All Users ({{ users|length }})</h4>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Farm Name</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr>
                            <td>{{ user.id }}</td>
                            <td>{{ user.name }}</td>
                            <td>{{ user.email }}</td>
                            <td>{{ user.farm_name or 'N/A' }}</td>
                            <td>
                                <span class="badge 
                                    {% if user.role.name == 'admin' %}bg-danger
                                    {% elif user.role.name == 'farmer' %}bg-warning
                                    {% else %}bg-info{% endif %}">
                                    {{ user.role.name }}
                                </span>
                            </td>
                            <td>
                                {% if user.role.name == 'farmer' %}
                                    {% if user.is_approved %}
                                        <span class="badge bg-success">Approved</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Pending</span>
                                    {% endif %}
                                {% else %}
                                    <span class="badge bg-light text-dark">—</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="#" class="btn btn-sm btn-info">View</a>
                                <a href="#" class="btn btn-sm btn-warning">Edit</a>
                                <!-- Delete Button with Safety Checks -->
                                {% if user.id != session['user_id'] and user.role.name != 'admin' %}
                                <a href="{{ url_for('delete_user', user_id=user.id) }}" 
                                   class="btn btn-sm btn-danger" 
                                   onclick="return confirm('Are you sure you want to delete {{ user.name }}? This action cannot be undone.');">
                                   Delete
                                </a>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Categories Management Section -->
    <div class="card mt-4">
        <div class="card-header">
            <h4>Manage Categories</h4>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h5>Add New Category</h5>
                    <form action="{{ url_for('add_category') }}" method="POST" class="row g-3">
                        <div class="col-8">
                            <input type="text" name="name" class="form-control" placeholder="Category name" required>
                        </div>
                        <div class="col-4">
                            <button type="submit" class="btn btn-primary w-100">Add Category</button>
                        </div>
                    </form>
                </div>
                <div class="col-md-6">
                    <h5>Existing Categories</h5>
                    {% if categories %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for category in categories %}
                                <tr>
                                    <td>{{ category.id }}</td>
                                    <td>{{ category.name }}</td>
                                    <td>
                                        <a href="{{ url_for('delete_category', id=category.id) }}" 
                                           class="btn btn-sm btn-danger"
                                           onclick="return confirm('Are you sure you want to delete this category?');">
                                           Delete
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted">No categories yet.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .card-header {
        font-weight: bold;
    }
    .table th {
        background-color: #f8f9fa;
    }
    .badge {
        font-size: 0.85em;
    }
    .btn-sm {
        margin: 2px;
    }
</style>
{% endblock %}